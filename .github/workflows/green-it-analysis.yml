name: Green IT

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  greenit:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout same commit
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '24'

      - name: Install dependencies
        run: |
          npm install
          npm run install:all

      - name: Build frontend
        run: |
          npm run build:frontend

      - name: Start backend & frontend
        run: |
          npm run start:backend &
          npm run start:frontend &
          npx wait-on http://localhost:8080

      - name: Create GreenIT-Analysis config
        run: |
          mkdir -p greenit/input greenit/output
          chmod -R 777 greenit/output
          cat > greenit/input/url.yaml << 'EOF'
          - name: 'Eco Trip Calculator'
            url: 'http://localhost:8080'
          EOF

      - name: Run GreenIT-Analysis
        run: |
          docker run --init --rm --cap-add=SYS_ADMIN \
            -v ${{ github.workspace }}/greenit/input:/app/input \
            -v ${{ github.workspace }}/greenit/output:/app/output \
            -e TZ=Europe/Paris \
            --network host \
            jpreisner/greenit-analysis-cli:latest \
            greenit analyse /app/input/url.yaml /app/output/results.html --ci --format=html

      - name: Green IT quality gate
        id: check_ecoindex
        run: |
          echo "Parsing GreenIT results from HTML..."

          # Extract EcoIndex from HTML
          ECOINDEX=$(grep -oP '\d+(?=&nbsp;<span class="grade)' greenit/output/results.html | head -1)

          if [ -z "$ECOINDEX" ]; then
            echo "❌ Failed to extract EcoIndex from HTML report"
            exit 1
          fi

          echo "EcoIndex: $ECOINDEX"
          echo "ecoindex=$ECOINDEX" >> $GITHUB_OUTPUT

          # Check if EcoIndex is less than 90
          if [ "$ECOINDEX" -lt 90 ]; then
            echo "❌ EcoIndex ($ECOINDEX) is below the required threshold of 90"
            exit 1
          else
            echo "✅ EcoIndex ($ECOINDEX) meets the required threshold of 90"
          fi

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: greenit-report
          path: |
            greenit/output/results.html